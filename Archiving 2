#!/bin/bash
###########################################
# Graylog Open Archiver (Enterprise Replacement)
# Does:
# - MongoDB backup
# - Elasticsearch/OpenSearch snapshot
# - Optional S3 upload
# - Rotation + cleanup
###########################################

# === EDIT THESE ===
ES_HOST="http://localhost:9200"
MONGO_DB="graylog"
BACKUP_DIR="/backup/graylog"
SNAP_REPO="graylog-archive"
S3_PATH=""       # example: s3://mybucket/graylog-archives
RETENTION_DAYS=30
LOGFILE="/var/log/graylog-archive.log"

DATE=$(date +%F_%H-%M)

log() {
  echo "[$(date +'%F %T')] $1" | tee -a "$LOGFILE"
}

mkdir -p "$BACKUP_DIR"

###########################################
# Register snapshot repo (safe repeat)
###########################################
log "Ensuring snapshot repo exists..."
curl -s -XPUT "$ES_HOST/_snapshot/$SNAP_REPO" \
  -H "Content-Type: application/json" \
  -d "{\"type\": \"fs\", \"settings\": { \"location\": \"$BACKUP_DIR/es\", \"compress\": true }}" >/dev/null

###########################################
# Mongo Backup
###########################################
log "Backing up MongoDB..."
mongodump --db "$MONGO_DB" --out "$BACKUP_DIR/mongo-$DATE"
if [[ $? -ne 0 ]]; then
  log "MongoDB backup FAILED"
  exit 1
fi

###########################################
# Snapshot Elasticsearch/OpenSearch
###########################################
log "Creating snapshot..."
curl -s -XPUT "$ES_HOST/_snapshot/$SNAP_REPO/snap-$DATE?wait_for_completion=true" \
  -H "Content-Type: application/json" \
  -d '{"indices":"*","ignore_unavailable":true,"include_global_state":true}' >/dev/null

if [[ $? -ne 0 ]]; then
  log "Snapshot FAILED"
  exit 1
fi

log "Snapshot completed."

###########################################
# Optional: Move archive to S3 / Remote
###########################################
if [[ -n "$S3_PATH" ]]; then
  log "Syncing archive to S3..."
  aws s3 sync "$BACKUP_DIR" "$S3_PATH"
  if [[ $? -ne 0 ]]; then
    log "S3 sync FAILED"
    exit 1
  fi
  log "S3 sync complete."
fi

###########################################
# Cleanup old backups
###########################################
log "Cleaning backups older than $RETENTION_DAYS days..."
find "$BACKUP_DIR" -type f -mtime +$RETENTION_DAYS -delete

log "Archive complete successfully."
exit 0

